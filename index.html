<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Rio Turfwars 2025</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            touch-action: manipulation;
        }
        .container-mobile {
            max-width: 420px;
            margin: auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .location-item {
            cursor: pointer;
            transition: all 0.15s;
        }
        .location-item:hover {
            opacity: 0.9;
            transform: scale(1.01);
        }
        .faction-color-cv { border-left-color: #ef4444; } /* Vermelho */
        .faction-color-tcp { border-left-color: #facc15; } /* Amarelo */
        .faction-color-mil { border-left-color: #a78bfa; } /* Lilás */

        /* Estilo para simular o visual de um feed/lista do Instagram */
        .instagram-like-card {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Efeito de botão */
        .action-button {
            transition: background-color 0.15s, transform 0.1s;
        }
        .action-button:active {
            transform: scale(0.98);
        }
        /* Estilo do Modal de Interação Centralizado e Elevado */
        .interaction-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center; 
        }
        .interaction-modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 90%;
            width: 320px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            /* Ajuste para levantar o modal na tela do celular, evitando que botões fiquem cortados */
            transform: translateY(-8vh); 
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="game-container" class="container-mobile">

        <!-- Header e Painel da Facção -->
        <header class="p-3 bg-white border-b-4 shadow-sm z-10 sticky top-0">
            <h1 class="text-xl font-extrabold text-gray-800">Rio Turfwars 2025</h1>
            <div id="faction-panel" class="mt-2 text-sm flex justify-between items-center text-gray-700">
                <!-- Conteúdo do Painel da Facção será inserido aqui pelo JS -->
            </div>
        </header>

        <!-- Log de Eventos (Pequeno e acima da lista) -->
        <div id="event-log" class="p-3 bg-white border-b border-gray-200 text-xs h-16 overflow-y-auto">
            <span class="font-semibold text-gray-600">Log de Turno:</span>
            <!-- Eventos inseridos aqui -->
        </div>

        <!-- Lista de Territórios (Simulando feed) -->
        <main id="location-list" class="flex-1 p-3 space-y-3 overflow-y-auto">
            <!-- Territórios serão inseridos aqui pelo JS -->
        </main>

        <!-- Footer / Botão de Turno -->
        <footer class="p-3 bg-gray-50 border-t sticky bottom-0 z-10">
            <button id="next-turn-button" class="w-full py-3 bg-gray-800 text-white font-bold rounded-xl action-button">
                Avançar Turno
            </button>
        </footer>

        <!-- Modal de Interação de Localidade (Oculto por padrão) -->
        <div id="interaction-modal" class="interaction-modal-backdrop hidden">
            <div id="modal-content" class="interaction-modal-content">
                <h2 id="modal-title" class="text-lg font-bold mb-3 text-center">Ações em [Local]</h2>
                <div id="modal-details" class="text-sm mb-4 space-y-1">
                    <!-- Detalhes da Localidade Alvo -->
                </div>

                <div id="modal-actions" class="space-y-3">
                    <!-- Ação: Reforçar (Comando direto na localidade clicada) -->
                    <div id="reinforce-section" class="border p-2 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-gray-700 mb-1">Reforçar Defesa (Local)</h3>
                        <p class="text-xs text-gray-500 mb-2">Aumenta a Força. Custo Base: R$ <span id="reinforce-cost">5.000,00</span> por ponto.</p>
                        
                        <label for="reinforce-amount" class="text-xs font-medium text-gray-700 block mb-1">Pontos de Força a Adicionar (Máx 10 por turno):</label>
                        <input type="range" id="reinforce-amount" min="1" max="10" value="1" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                        
                        <div class="flex justify-between text-xs mt-1 mb-2">
                            <span id="reinforce-value" class="font-semibold">1 Ponto</span>
                            <span id="reinforce-total-cost" class="font-bold text-gray-800">Custo Total: R$ 5.000,00</span>
                        </div>

                        <button id="btn-reinforce" class="w-full py-2 bg-green-600 text-white text-sm font-semibold rounded-lg action-button disabled:opacity-50" disabled>
                            Reforçar
                        </button>
                    </div>

                    <!-- Ação: Ataque / Baque (Menu expandido) -->
                    <div id="attack-section" class="border p-2 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-gray-700 mb-1">Ataque / Baque</h3>
                        <p class="text-xs text-gray-500 mb-2">Escolha a origem do ataque e o tipo de ofensiva.</p>

                        <select id="attack-origin-select" class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2"></select>

                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="is-raid-checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                            <label for="is-raid-checkbox" class="ml-2 text-sm font-medium text-gray-700">É um Baque (Não visa domínio)</label>
                        </div>

                        <button id="btn-attack" class="w-full py-2 bg-red-600 text-white text-sm font-semibold rounded-lg action-button disabled:opacity-50" disabled>
                            Preparar Invasão
                        </button>
                        <p id="attack-cost-display" class="text-xs text-gray-500 text-center mt-2"></p>
                    </div>

                    <button id="btn-close-modal" class="w-full py-2 bg-gray-200 text-gray-800 text-sm font-semibold rounded-lg action-button">
                        Fechar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Definições de Facções e Cores
        const FACTIONS = {
            'CV': { id: 'CV', name: 'Comando Vermelho', colorClass: 'faction-color-cv', colorHex: '#ef4444' },
            'TCP': { id: 'TCP', name: 'Terceiro Comando Puro', colorClass: 'faction-color-tcp', colorHex: '#facc15' },
            'MIL': { id: 'MIL', name: 'Milícia', colorClass: 'faction-color-mil', colorHex: '#a78bfa' },
            'PLAYER': null // Definido no início do jogo
        };

        // ---------- NOVAS BASE_LOCATIONS (Atualizado conforme o pedido) ----------
        // id: string curta única (sem espaços), name: nome real, zone: ZN/ZS/CT/ZO/BX, baseIncome, initialForce, owner
        const BASE_LOCATIONS = [
            // Zona Sul (ZS)
            {"id":"Rocinha","name":"Rocinha","zone":"ZS","baseIncome":22000,"initialForce":28,"owner":"CV"},
            {"id":"Vidigal","name":"Vidigal","zone":"ZS","baseIncome":17000,"initialForce":21,"owner":"CV"},
            {"id":"MorroDoisIrmaos","name":"Morro Dois Irmãos","zone":"ZS","baseIncome":16500,"initialForce":20,"owner":"CV"},
            {"id":"SantaMarta","name":"Santa Marta","zone":"ZS","baseIncome":14000,"initialForce":16,"owner":"CV"},
            {"id":"MorroDaBabilonia","name":"Morro da Babilônia","zone":"ZS","baseIncome":15000,"initialForce":18,"owner":"CV"},
            {"id":"ChapeuMangueira","name":"Chapéu Mangueira","zone":"ZS","baseIncome":11900,"initialForce":13,"owner":"CV"},
            {"id":"Leme","name":"Leme (Favela)","zone":"ZS","baseIncome":12200,"initialForce":13,"owner":"CV"},
            {"id":"MorroDosPrazeres","name":"Morro dos Prazeres","zone":"ZS","baseIncome":13800,"initialForce":16,"owner":"CV"},
            {"id":"MorroPavao","name":"Morro do Pavão-Pavãozinho","zone":"ZS","baseIncome":15500,"initialForce":19,"owner":"CV"},
            {"id":"Cantagalo","name":"Cantagalo","zone":"ZS","baseIncome":16000,"initialForce":19,"owner":"CV"},
            {"id":"LadeiraTabajaras","name":"Ladeira dos Tabajaras","zone":"ZS","baseIncome":14500,"initialForce":17,"owner":"CV"},
            {"id":"MorroDosCabritos","name":"Morro dos Cabritos","zone":"ZS","baseIncome":13000,"initialForce":15,"owner":"CV"},
            {"id":"MorroAzul","name":"Morro Azul (Botafogo)","zone":"ZS","baseIncome":11000,"initialForce":11,"owner":"CV"},
            {"id":"MorroDaViuva","name":"Morro da Viúva","zone":"ZS","baseIncome":10500,"initialForce":10,"owner":"CV"},
            {"id":"MorroDoVidigal","name":"Morro do Vidigal","zone":"ZS","baseIncome":16800,"initialForce":20,"owner":"CV"},
            {"id":"ChacaraDoCeu","name":"Morro da Chácara do Céu (Vidigal)","zone":"ZS","baseIncome":11300,"initialForce":11,"owner":"CV"},
            
            // Zona Norte / Grande Tijuca (ZN_TJ) - Usando ZN
            {"id":"ComplexoDoAlemao","name":"Complexo do Alemão","zone":"ZN","baseIncome":15500,"initialForce":22,"owner":"TCP"},
            {"id":"ComplexoDoLins","name":"Complexo do Lins","zone":"ZN","baseIncome":12500,"initialForce":14,"owner":"MIL"},
            {"id":"MorroDaFormiga","name":"Morro da Formiga","zone":"ZN","baseIncome":11800,"initialForce":12,"owner":"CV"},
            {"id":"MorroDoBorel","name":"Morro do Borel","zone":"ZN","baseIncome":13000,"initialForce":15,"owner":"CV"},
            {"id":"ComplexoSaoCarlos","name":"Complexo de São Carlos","zone":"ZN","baseIncome":10400,"initialForce":10,"owner":"MIL"},
            {"id":"MorroDosMacacos","name":"Morro dos Macacos","zone":"ZN","baseIncome":12400,"initialForce":13,"owner":"CV"},
            {"id":"MorroDeSaoJoao","name":"Morro de São João","zone":"ZN","baseIncome":9000,"initialForce":8,"owner":"MIL"},
            {"id":"MorroDaMangueira","name":"Morro da Mangueira","zone":"ZN","baseIncome":12300,"initialForce":14,"owner":"CV"},
            {"id":"MorroDoAndarai","name":"Morro do Andaraí","zone":"ZN","baseIncome":11000,"initialForce":11,"owner":"CV"},
            {"id":"MorroDoSalgueiro","name":"Morro do Salgueiro","zone":"ZN","baseIncome":13500,"initialForce":16,"owner":"CV"},
            {"id":"MorroDaCruz","name":"Morro da Cruz","zone":"ZN","baseIncome":10000,"initialForce":10,"owner":"CV"},
            {"id":"MorroDoPauDaBandeira","name":"Morro do Pau da Bandeira","zone":"ZN","baseIncome":11200,"initialForce":11,"owner":"MIL"},
            {"id":"MorroDoMacacoTijuca","name":"Morro do Macaco (Tijuca)","zone":"ZN","baseIncome":10500,"initialForce":11,"owner":"CV"},
            {"id":"MorroDoBicoDoPapagaio","name":"Morro do Bico do Papagaio (Tijuca)","zone":"ZN","baseIncome":9800,"initialForce":10,"owner":"CV"},
            {"id":"MorroDaMatriz","name":"Morro da Matriz (São Cristóvão)","zone":"ZN","baseIncome":9500,"initialForce":9,"owner":"MIL"},
            {"id":"MorroDoTuiuti","name":"Morro do Tuiuti","zone":"ZN","baseIncome":9400,"initialForce":9,"owner":"MIL"},
            {"id":"MorroDaBarreiraDoVasco","name":"Morro da Barreira do Vasco","zone":"ZN","baseIncome":8800,"initialForce":8,"owner":"MIL"},
            {"id":"Jacarezinho","name":"Jacarezinho","zone":"ZN","baseIncome":15000,"initialForce":20,"owner":"CV"},
            {"id":"ComplexoDeManguinhos","name":"Complexo de Manguinhos","zone":"ZN","baseIncome":14000,"initialForce":16,"owner":"TCP"},
            {"id":"MorroDoUrubu","name":"Morro do Urubu","zone":"ZN","baseIncome":11500,"initialForce":12,"owner":"MIL"},
            {"id":"MorroDaPrimavera","name":"Morro da Primavera (Cavalcanti)","zone":"ZN","baseIncome":10800,"initialForce":10,"owner":"MIL"},
            {"id":"MorroDoEngenho","name":"Morro do Engenho (Engenho Novo)","zone":"ZN","baseIncome":10200,"initialForce":10,"owner":"MIL"},

            // Zona Oeste (ZO)
            {"id":"CidadeDeDeus","name":"Cidade de Deus","zone":"ZO","baseIncome":20000,"initialForce":25,"owner":"MIL"},
            {"id":"RioDasPedras","name":"Rio das Pedras","zone":"ZO","baseIncome":18500,"initialForce":22,"owner":"MIL"},
            {"id":"ComplexoDaMuzema","name":"Complexo da Muzema","zone":"ZO","baseIncome":15000,"initialForce":16,"owner":"MIL"},
            {"id":"VilaCanoas","name":"Vila Canoas","zone":"ZO","baseIncome":12500,"initialForce":13,"owner":"CV"},
            {"id":"MorroDoBanco","name":"Morro do Banco","zone":"ZO","baseIncome":13000,"initialForce":14,"owner":"MIL"},
            {"id":"MorroDoAnaia","name":"Morro do Anaia","zone":"ZO","baseIncome":10500,"initialForce":11,"owner":"MIL"},
            {"id":"MorroDaTijuquinha","name":"Morro da Tijuquinha","zone":"ZO","baseIncome":11000,"initialForce":11,"owner":"MIL"},
            {"id":"MorroDoFuba","name":"Morro do Fubá","zone":"ZO","baseIncome":12500,"initialForce":13,"owner":"MIL"},
            {"id":"ComplexoDaCovanca","name":"Complexo da Covanca","zone":"ZO","baseIncome":14000,"initialForce":15,"owner":"MIL"},
            {"id":"MorroDoJordao","name":"Morro do Jordão","zone":"ZO","baseIncome":13500,"initialForce":16,"owner":"MIL"},
            {"id":"MorroDoCampinho","name":"Morro do Campinho","zone":"ZO","baseIncome":11800,"initialForce":12,"owner":"MIL"},
            {"id":"MorroDoBateauMouche","name":"Morro do Bateau Mouche","zone":"ZO","baseIncome":11000,"initialForce":11,"owner":"MIL"},
            {"id":"MorroDoFuba","name":"Morro do Barata","zone":"ZO","baseIncome":10500,"initialForce":10,"owner":"MIL"},
            {"id":"VilaKennedy","name":"Vila Kennedy","zone":"ZO","baseIncome":13700,"initialForce":15,"owner":"MIL"},
            {"id":"VilaAlianca","name":"Vila Aliança","zone":"ZO","baseIncome":13500,"initialForce":16,"owner":"TCP"},
            {"id":"VilaVintem","name":"Vila Vintém","zone":"ZO","baseIncome":9400,"initialForce":9,"owner":"MIL"},
            
            // Zona Central / Grande Centro (CT)
            {"id":"MorroDaProvidencia","name":"Morro da Providência","zone":"CT","baseIncome":12000,"initialForce":13,"owner":"CV"},
            {"id":"MorroDoFallet","name":"Morro do Fallet","zone":"CT","baseIncome":10000,"initialForce":10,"owner":"TCP"},
            {"id":"MorroDoTurano","name":"Morro do Turano","zone":"CT","baseIncome":11900,"initialForce":13,"owner":"CV"},
            {"id":"MorroDaCoroa","name":"Morro da Coroa","zone":"CT","baseIncome":10100,"initialForce":11,"owner":"CV"},
            {"id":"MorroDaMineira","name":"Morro da Mineira","zone":"CT","baseIncome":11900,"initialForce":13,"owner":"CV"},
            {"id":"MorroDoZinco","name":"Morro do Zinco","zone":"CT","baseIncome":9800,"initialForce":10,"owner":"MIL"},
            {"id":"MorroDoQuerosene","name":"Morro do Querosene","zone":"CT","baseIncome":9700,"initialForce":9,"owner":"MIL"},
            {"id":"MorroDeSantaTeresa","name":"Morro de Santa Teresa","zone":"CT","baseIncome":11600,"initialForce":12,"owner":"CV"},
            {"id":"MorroDoPereirao","name":"Morro do Pereirão","zone":"CT","baseIncome":11500,"initialForce":12,"owner":"CV"},
            {"id":"MorroDoPinto","name":"Morro do Pinto","zone":"CT","baseIncome":11000,"initialForce":11,"owner":"CV"},
            {"id":"MorroDaConceicao","name":"Morro da Conceição","zone":"CT","baseIncome":10500,"initialForce":10,"owner":"CV"},
            {"id":"MorroVilaCandida","name":"Morro da Vila Cândida (Catumbi)","zone":"CT","baseIncome":10200,"initialForce":10,"owner":"CV"},
            {"id":"MorroDoEscondidinho","name":"Morro do Escondidinho","zone":"CT","baseIncome":9800,"initialForce":10,"owner":"CV"},

            // Zona da Leopoldina e Adjacências (ZN_LEO) - Usando ZN
            {"id":"ComplexoDaMare","name":"Complexo da Maré","zone":"ZN","baseIncome":14800,"initialForce":20,"owner":"TCP"},
            {"id":"VilaDoJoao","name":"Vila do João","zone":"ZN","baseIncome":13500,"initialForce":16,"owner":"TCP"},
            {"id":"ParqueUniao","name":"Parque União","zone":"ZN","baseIncome":12000,"initialForce":13,"owner":"TCP"},
            {"id":"NovaHolanda","name":"Nova Holanda","zone":"ZN","baseIncome":11800,"initialForce":12,"owner":"TCP"},
            {"id":"BaixaDoSapateiro","name":"Baixa do Sapateiro","zone":"ZN","baseIncome":11500,"initialForce":12,"owner":"TCP"},
            {"id":"ComplexoDaPenha","name":"Complexo da Penha","zone":"ZN","baseIncome":12800,"initialForce":15,"owner":"TCP"},
            {"id":"MorroDaBica","name":"Morro da Bica (Penha)","zone":"ZN","baseIncome":11000,"initialForce":11,"owner":"TCP"},
            {"id":"MorroDaFe","name":"Morro da Fé","zone":"ZN","baseIncome":10800,"initialForce":10,"owner":"TCP"},
            {"id":"MorroDoAdeus","name":"Morro do Adeus","zone":"ZN","baseIncome":10500,"initialForce":10,"owner":"TCP"},
            {"id":"MorroDaBaiana","name":"Morro da Baiana","zone":"ZN","baseIncome":9800,"initialForce":10,"owner":"MIL"},
            {"id":"CaixaDAguaPenha","name":"Morro da Caixa D'Água (Penha)","zone":"ZN","baseIncome":9700,"initialForce":9,"owner":"MIL"},
            {"id":"MorroDoSereno","name":"Morro do Sereno (Penha)","zone":"ZN","baseIncome":9500,"initialForce":9,"owner":"TCP"},
            {"id":"MorroDaChatubaPenha","name":"Morro da Chatuba (Penha)","zone":"ZN","baseIncome":9400,"initialForce":9,"owner":"TCP"},
            {"id":"MorroDoAlemaoComp","name":"Morro do Alemão (Complexo)","zone":"ZN","baseIncome":14600,"initialForce":18,"owner":"TCP"},

            // Zona Norte / Subúrbio (ZN_SUB) - Usando ZN
            {"id":"MorroDoJuramento","name":"Morro do Juramento","zone":"ZN","baseIncome":12800,"initialForce":15,"owner":"TCP"},
            {"id":"MorroDoJorgeTurco","name":"Morro do Jorge Turco","zone":"ZN","baseIncome":11500,"initialForce":12,"owner":"CV"},
            {"id":"MorroDaSerrinha","name":"Morro da Serrinha","zone":"ZN","baseIncome":14500,"initialForce":18,"owner":"TCP"},
            {"id":"MorroDoCajueiro","name":"Morro do Cajueiro (Madureira)","zone":"ZN","baseIncome":13200,"initialForce":16,"owner":"CV"},
            {"id":"CidadeAlta","name":"Cidade Alta","zone":"ZN","baseIncome":14500,"initialForce":17,"owner":"CV"},
            {"id":"VigarioGeral","name":"Vigário Geral","zone":"ZN","baseIncome":14000,"initialForce":16,"owner":"CV"},
            {"id":"ParadaDeLucas","name":"Parada de Lucas","zone":"ZN","baseIncome":10800,"initialForce":10,"owner":"MIL"},
            {"id":"ComplexoDaPedreira","name":"Complexo da Pedreira","zone":"ZN","baseIncome":13000,"initialForce":14,"owner":"MIL"},
            {"id":"MorroDoChapadão","name":"Morro do Chapadão","zone":"ZN","baseIncome":12500,"initialForce":13,"owner":"CV"},
            {"id":"MorroDaPedreira","name":"Morro da Pedreira","zone":"ZN","baseIncome":11800,"initialForce":12,"owner":"MIL"},
            {"id":"MorroDoGogoDaEma","name":"Morro do Gogó da Ema","zone":"ZN","baseIncome":12500,"initialForce":14,"owner":"TCP"},
            {"id":"MorroDoFinalFeliz","name":"Morro do Final Feliz","zone":"ZN","baseIncome":11000,"initialForce":11,"owner":"MIL"},
            {"id":"ComplexoDoMuquico","name":"Complexo do Muquiço","zone":"ZN","baseIncome":10500,"initialForce":10,"owner":"MIL"},
            {"id":"MorroDoCamboata","name":"Morro do Camboatá","zone":"ZN","baseIncome":10200,"initialForce":10,"owner":"MIL"},
            {"id":"MorroDaCongonha","name":"Morro da Congonha","zone":"ZN","baseIncome":9800,"initialForce":10,"owner":"MIL"},

            // Ilha do Governador e Outros (ZN_ILHA) - Usando ZN
            {"id":"MorroDoDende","name":"Morro do Dendê (Ilha do Governador)","zone":"ZN","baseIncome":15500,"initialForce":22,"owner":"TCP"},
            {"id":"MorroDaTubiacanga","name":"Morro da Tubiacanga","zone":"ZN","baseIncome":9500,"initialForce":9,"owner":"TCP"},
            {"id":"MorroDoCoqueiro","name":"Morro do Coqueiro","zone":"ZN","baseIncome":9200,"initialForce":8,"owner":"MIL"},
            {"id":"MorroDoBudapeste","name":"Morro do Budapeste","zone":"ZN","baseIncome":9000,"initialForce":8,"owner":"MIL"},
            {"id":"MorroDoJuramentinho","name":"Morro do Juramentinho","zone":"ZN","baseIncome":10000,"initialForce":10,"owner":"TCP"},
            {"id":"MorroDoGamba","name":"Morro do Gambá (Lins de Vasconcelos)","zone":"ZN","baseIncome":11000,"initialForce":11,"owner":"MIL"},
            {"id":"MorroDaCachoeiraGrande","name":"Morro da Cachoeira Grande (Lins de Vasconcelos)","zone":"ZN","baseIncome":10500,"initialForce":11,"owner":"MIL"},
        ];
        // ---------- fim NOVAS BASE_LOCATIONS ----------

        // ---------- ADJACENCIES_STATIC (Grafo Fixo conforme o pedido) ----------
        // O grafo foi gerado manualmente a partir do texto fornecido.
        const ADJACENCIES_STATIC = {
            "Rocinha": ["Vidigal", "MorroDoisIrmaos"],
            "Vidigal": ["Rocinha", "ChacaraDoCeu", "MorroDoisIrmaos", "MorroDoVidigal"],
            "MorroDoisIrmaos": ["Vidigal", "Rocinha"],
            "SantaMarta": ["MorroDaBabilonia", "MorroDosPrazeres"],
            "MorroDaBabilonia": ["ChapeuMangueira", "Leme", "SantaMarta"],
            "ChapeuMangueira": ["MorroDaBabilonia", "Leme"],
            "MorroDosPrazeres": ["SantaMarta", "MorroDoFallet"],
            "MorroPavao": ["Cantagalo"], // Apenas adjacente aos vizinhos de jogo (Copacabana e Ipanema não são localidades)
            "Cantagalo": ["MorroPavao"], // Apenas adjacente aos vizinhos de jogo
            "LadeiraTabajaras": ["MorroDosCabritos"], // Apenas adjacente aos vizinhos de jogo
            "MorroDosCabritos": ["LadeiraTabajaras", "MorroAzul"], // Apenas adjacente aos vizinhos de jogo
            "MorroAzul": ["MorroDosCabritos", "MorroDaViuva"], // Apenas adjacente aos vizinhos de jogo
            "MorroDaViuva": ["MorroAzul"], // Apenas adjacente aos vizinhos de jogo
            "MorroDoVidigal": ["Rocinha", "Vidigal", "ChacaraDoCeu"], // Adicionei Rocinha e Vidigal
            "ChacaraDoCeu": ["Vidigal", "MorroDoVidigal"],
            "ComplexoDoAlemao": ["ComplexoDaPenha", "MorroDoJuramento", "MorroDoAlemaoComp", "MorroDoAdeus"],
            "ComplexoDoLins": ["MorroDaCachoeiraGrande", "MorroDoGamba"],
            "MorroDaFormiga": ["MorroDoBorel", "MorroDaCruz"],
            "MorroDoBorel": ["MorroDaFormiga", "MorroDoSalgueiro", "MorroDoAndarai"],
            "ComplexoSaoCarlos": ["MorroDaMineira", "MorroDoZinco", "MorroDoQuerosene"],
            "MorroDosMacacos": ["MorroDeSaoJoao"],
            "MorroDeSaoJoao": ["MorroDosMacacos", "MorroDaBarreiraDoVasco", "MorroDaMangueira"],
            "MorroDaMangueira": ["MorroDeSaoJoao"],
            "MorroDoAndarai": ["MorroDoBorel", "MorroDoPauDaBandeira"],
            "MorroDoSalgueiro": ["MorroDoBorel", "MorroDoMacacoTijuca"], // Tijuca não é localidade
            "MorroDaCruz": ["MorroDaFormiga"], // Alto da Boa Vista não é localidade
            "MorroDoPauDaBandeira": ["MorroDoAndarai"], // Tijuca não é localidade
            "MorroDoMacacoTijuca": ["MorroDoSalgueiro"], // Tijuca não é localidade
            "MorroDoBicoDoPapagaio": [], // Tijuca e Alto da Boa Vista não são localidades
            "MorroDaMatriz": ["MorroDoTuiuti"], // São Cristóvão e Caju não são localidades
            "MorroDoTuiuti": ["MorroDaMatriz", "MorroDaBarreiraDoVasco"], // São Cristóvão não é localidade
            "MorroDaBarreiraDoVasco": ["MorroDeSaoJoao", "MorroDoTuiuti"],
            "Jacarezinho": ["ComplexoDeManguinhos", "MorroDoUrubu"],
            "ComplexoDeManguinhos": ["Jacarezinho", "ComplexoDaMare"],
            "MorroDoUrubu": [], // Piedade e Pilares não são localidades
            "MorroDaPrimavera": [], // Cavalcanti e Inhaúma não são localidades
            "MorroDoEngenho": ["ComplexoDoLins", "MorroDaCachoeiraGrande", "MorroDoGamba"], // Lins de Vasconcelos não é localidade
            "CidadeDeDeus": ["RioDasPedras", "ComplexoDaMuzema"],
            "RioDasPedras": ["CidadeDeDeus", "ComplexoDaMuzema"],
            "ComplexoDaMuzema": ["RioDasPedras", "MorroDoBanco"], // Itanhangá não é localidade
            "VilaCanoas": ["Rocinha"], // São Conrado e Rocinha
            "MorroDoBanco": ["ComplexoDaMuzema", "MorroDoAnaia"], // Itanhangá não é localidade
            "MorroDoAnaia": ["MorroDoBanco"], // Itanhangá e Jacarepaguá não são localidades
            "MorroDaTijuquinha": [], // Barra da Tijuca e Itanhangá não são localidades
            "MorroDoFuba": ["ComplexoDaCovanca", "MorroDoCampinho"], // Morro da Iguaíba não é localidade
            "ComplexoDaCovanca": ["MorroDoFuba", "MorroDoJordao"],
            "MorroDoJordao": ["ComplexoDaCovanca"], // Tanque não é localidade
            "MorroDoCampinho": ["MorroDoFuba"], // Praça Seca não é localidade
            "MorroDoBateauMouche": [], // Jacarepaguá e Taquara não são localidades
            "MorroDoBarata": ["VilaKennedy", "VilaAlianca"], // Realengo e Bangu não são localidades
            "VilaKennedy": ["VilaAlianca", "MorroDoBarata"], // Bangu não é localidade
            "VilaAlianca": ["VilaKennedy", "MorroDoBarata"], // Bangu não é localidade
            "VilaVintem": [], // Senador Camará e Padre Miguel não são localidades
            "MorroDaProvidencia": ["MorroDoPinto", "MorroDaConceicao"],
            "MorroDoFallet": ["MorroDeSantaTeresa", "MorroDosPrazeres"],
            "MorroDoTurano": ["MorroDaCoroa", "MorroVilaCandida"], // Catumbi não é localidade
            "MorroDaCoroa": ["MorroDoTurano"], // Catumbi e Rio Comprido não são localidades
            "MorroDaMineira": ["ComplexoSaoCarlos", "MorroDoQuerosene"],
            "MorroDoZinco": ["ComplexoSaoCarlos", "MorroDoQuerosene"], // Praça da Bandeira não é localidade
            "MorroDoQuerosene": ["ComplexoSaoCarlos", "MorroDaMineira", "MorroDoZinco"], // Praça da Bandeira não é localidade
            "MorroDeSantaTeresa": ["MorroDoFallet", "MorroVilaCandida", "MorroDoEscondidinho"], // Catumbi não é localidade
            "MorroDoPereirao": [], // Laranjeiras e Catete não são localidades
            "MorroDoPinto": ["MorroDaProvidencia"], // Gamboa não é localidade
            "MorroDaConceicao": ["MorroDaProvidencia"], // Centro não é localidade
            "MorroVilaCandida": ["MorroDeSantaTeresa", "MorroDoTurano"], // Catumbi não é localidade
            "MorroDoEscondidinho": ["MorroDeSantaTeresa"], // Rio Comprido não é localidade
            "ComplexoDaMare": ["ComplexoDeManguinhos", "VilaDoJoao", "ParqueUniao", "NovaHolanda", "BaixaDoSapateiro"],
            "VilaDoJoao": ["ComplexoDaMare"], // Cidade Universitária não é localidade
            "ParqueUniao": ["ComplexoDaMare"], // Bonsucesso não é localidade
            "NovaHolanda": ["ComplexoDaMare"], // Bonsucesso não é localidade
            "BaixaDoSapateiro": ["ComplexoDaMare"], // Fundão não é localidade
            "ComplexoDaPenha": ["ComplexoDoAlemao", "MorroDoSereno", "MorroDoAlemaoComp"],
            "MorroDaBica": ["MorroDaFe"], // Penha não é localidade
            "MorroDaFe": ["MorroDaBica"], // Penha não é localidade
            "MorroDoAdeus": ["ComplexoDoAlemao"], // Ramos não é localidade
            "MorroDaBaiana": ["CaixaDAguaPenha"], // Olaria e Ramos não são localidades
            "CaixaDAguaPenha": ["MorroDaBaiana", "MorroDaChatubaPenha"], // Penha e Olaria não são localidades
            "MorroDoSereno": ["ComplexoDaPenha"], // Penha Circular não é localidade
            "MorroDaChatubaPenha": ["CaixaDAguaPenha"], // Penha e Brás de Pina não são localidades
            "MorroDoAlemaoComp": ["ComplexoDaPenha", "ComplexoDoAlemao"], // Ramos não é localidade
            "MorroDoJuramento": ["ComplexoDoAlemao", "MorroDoCajueiro", "MorroDoJuramentinho"],
            "MorroDoJorgeTurco": ["MorroDoFinalFeliz"], // Coelho Neto e Honório Gurgel não são localidades
            "MorroDaSerrinha": ["MorroDoCajueiro"], // Madureira não é localidade
            "MorroDoCajueiro": ["MorroDaSerrinha", "MorroDoJuramento"], // Madureira não é localidade
            "CidadeAlta": ["VigarioGeral", "ParadaDeLucas"],
            "VigarioGeral": ["CidadeAlta", "ParadaDeLucas"],
            "ParadaDeLucas": ["VigarioGeral", "CidadeAlta"],
            "ComplexoDaPedreira": ["MorroDoGogoDaEma", "MorroDoFinalFeliz", "MorroDaPedreira"], // Final Feliz não é localidade
            "MorroDoChapadão": ["MorroDaPedreira"], // Costa Barros e Pavuna não são localidades
            "MorroDaPedreira": ["MorroDoChapadão", "ComplexoDaPedreira", "MorroDoGogoDaEma"], // Costa Barros não é localidade
            "MorroDoGogoDaEma": ["ComplexoDaPedreira", "MorroDaPedreira"], // Costa Barros não é localidade
            "MorroDoFinalFeliz": ["ComplexoDaPedreira", "MorroDoJorgeTurco"], // Coelho Neto não é localidade
            "ComplexoDoMuquico": ["MorroDoCamboata"], // Guadalupe e Deodoro não são localidades
            "MorroDoCamboata": ["ComplexoDoMuquico"], // Deodoro e Guadalupe não são localidades
            "MorroDaCongonha": [], // Complexo da Congonha e Morro do Sapé não são localidades
            "MorroDoDende": ["MorroDaTubiacanga", "MorroDoCoqueiro", "MorroDoBudapeste"], // Ilha do Governador
            "MorroDaTubiacanga": ["MorroDoDende"], // Ilha do Governador
            "MorroDoCoqueiro": ["MorroDoDende"], // Ilha do Governador e Praia da Rosa
            "MorroDoBudapeste": ["MorroDoDende"], // Ilha do Governador e Galeão
            "MorroDoJuramentinho": ["MorroDoJuramento"], // Engenho da Rainha não é localidade
            "MorroDoGamba": ["ComplexoDoLins", "MorroDoEngenho"], // Engenho Novo não é localidade
            "MorroDaCachoeiraGrande": ["ComplexoDoLins", "MorroDoEngenho"], // Engenho Novo não é localidade
        };
        // ---------- fim ADJACENCIES_STATIC ----------


        // Funções de geração dinâmica de Coordenadas/Distâncias desativadas
        // (Foram mantidas por questões de estrutura, mas não são mais usadas para adjacência)
        const zoneCenters = {
            'ZS': { x: 80, y: 20 },
            'CT': { x: 60, y: 40 },
            'ZN': { x: 40, y: 70 },
            'ZO': { x: 10, y: 50 },
            'BX': { x: -20, y: 60 }
        };
        function deterministicRandom(seed) {
            let h = 2166136261 >>> 0;
            for (let i = 0; i < seed.length; i++) {
                h ^= seed.charCodeAt(i);
                h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
            }
            return (h >>> 0) / 4294967295;
        }
        function assignHypotheticalCoords(locations) {
            return locations.map(loc => {
                const center = zoneCenters[loc.zone] || { x: 0, y: 0 };
                const r1 = deterministicRandom(loc.id + '_x');
                const r2 = deterministicRandom(loc.id + '_y');
                const x = center.x + (r1 - 0.5) * 16; // variação ±8
                const y = center.y + (r2 - 0.5) * 16;
                return Object.assign({}, loc, { x: parseFloat(x.toFixed(4)), y: parseFloat(y.toFixed(4)) });
            });
        }
        
        // Variáveis derivadas (Coords e Distâncias ainda são geradas, mas ADJACENCIES_DYNAMIC é renomeado para ADJACENCIES_STATIC)
        const LOCS_WITH_COORDS = assignHypotheticalCoords(BASE_LOCATIONS);
        // O objeto DISTANCES e a função computeDistances não são necessários para a adjacência fixa.
        // const DISTANCES = computeDistances(LOCS_WITH_COORDS); 
        const ADJACENCIES_DYNAMIC = ADJACENCIES_STATIC; // O nome da variável de adjacência usada no resto do código é ADJACENCIES_DYNAMIC, então a reatribuição garante a compatibilidade.

        // Função utilitária para checar adjacência usando o grafo gerado
        const isLocationAdjacent = (id1, id2) => {
            // Usa o grafo estático/fixo ADJACENCIES_STATIC (agora em ADJACENCIES_DYNAMIC)
            return ADJACENCIES_DYNAMIC[id1]?.includes(id2) || ADJACENCIES_DYNAMIC[id2]?.includes(id1) || false;
        };
        // Fim das funções de Adjacência


        // Custos e Fatores
        const REINFORCE_COST_PER_POINT = 5000;
        const ATTACK_COST_BASE = 15000;
        const ADJACENCY_PENALTY = 0.5; // Redução FIXA de 50% na força de ataque para ataque não adjacente
        const MAX_FORCE = 100;
        const MAX_MORAL = 100;
        const MAX_REINFORCE_PER_TURN = 100; // Limite para o slider

        // Estado do Jogo
        let gameState = {
            turn: 1,
            factions: {},
            locations: [],
            playerFactionId: 'CV', // Define CV como player padrão
            selectedLocationId: null,
            eventLog: []
        };

        // Funções de Utilidade
        const formatMoney = (amount) => `R$ ${amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const addLog = (message, type = 'info') => {
            const now = new Date();
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            gameState.eventLog.push({ time, message, type });
            if (gameState.eventLog.length > 100) gameState.eventLog.shift(); // Limita o log
        };

        // Renderização
        const renderFactionPanel = () => {
            const player = gameState.factions[gameState.playerFactionId];
            const panel = document.getElementById('faction-panel');

            // Determina a cor da barra de status
            const color = FACTIONS[player.id].colorHex;

            panel.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-semibold">${player.name}</span>
                    <span style="background-color: ${color};" class="inline-block w-3 h-3 rounded-full border border-gray-300"></span>
                </div>
                <span class="text-sm font-semibold">Renda: ${formatMoney(player.money)}</span>
                <span class="text-sm font-semibold">Turno: ${gameState.turn}</span>
            `;
            // Adiciona a cor da borda ao cabeçalho (para simular a facção)
            document.querySelector('header').style.borderBottomColor = color;
        };

        const renderEventLog = () => {
            const logElement = document.getElementById('event-log');
            logElement.innerHTML = `<span class="font-semibold text-gray-600">Log de Turno:</span>`;
            // Exibe apenas os últimos 100 logs para manter o painel pequeno
            const recentLogs = gameState.eventLog.slice(-100);
            recentLogs.forEach(log => {
                let color = 'text-gray-600';
                if (log.type === 'attack') color = 'text-red-700 font-medium';
                if (log.type === 'success') color = 'text-green-600 font-medium';
                if (log.type === 'police') color = 'text-blue-700 font-medium';
                if (log.type === 'income') color = 'text-green-500';
                if (log.type === 'system') color = 'text-gray-500';

                logElement.innerHTML += `<p class="${color} text-xs leading-tight">**${log.time}** ${log.message}</p>`;
            });
            logElement.scrollTop = logElement.scrollHeight; // Scroll para o final
        };

        const renderMap = () => {
            const list = document.getElementById('location-list');
            list.innerHTML = '';

            // Mapeamento de Zonas para exibição ordenada
            const zonesOrder = ['ZS', 'CT', 'ZN', 'ZO']; // Ordene conforme a nova distribuição
            const sortedLocations = [...gameState.locations].sort((a, b) => {
                const zoneA = zonesOrder.indexOf(a.zone);
                const zoneB = zonesOrder.indexOf(b.zone);
                if (zoneA !== zoneB) return zoneA - zoneB;
                return a.name.localeCompare(b.name);
            });

            sortedLocations.forEach(loc => {
                const owner = FACTIONS[loc.owner];
                const moralText = loc.moral > 75 ? 'Alta' : (loc.moral > 40 ? 'Média' : 'Baixa');

                const item = document.createElement('div');
                item.className = `location-item p-3 border-l-4 rounded-xl bg-white shadow-md flex justify-between items-center ${owner.colorClass}`;
                item.dataset.id = loc.id;
                item.onclick = () => handleLocationClick(loc.id);

                item.innerHTML = `
                    <div>
                        <div class="text-sm font-bold text-gray-800">${loc.name} (${loc.zone})</div>
                        <div class="text-xs text-gray-500">
                            Domínio: <span class="font-semibold" style="color:${owner.colorHex};">${owner.name}</span>
                        </div>
                    </div>
                    <div class="text-right text-xs space-y-0.5">
                        <p class="font-semibold text-gray-700">Renda: ${formatMoney(loc.income)}</p>
                        <p class="text-gray-600">Força: <span class="font-bold">${loc.force} / ${MAX_FORCE}</span></p>
                        <p class="text-gray-600">Moral: <span class="font-bold">${loc.moral}% (${moralText})</span></p>
                    </div>
                `;
                list.appendChild(item);
            });
        };

        // Lógica de Inicialização
        const initGame = () => {
            // Inicializa facções e dinheiro
            gameState.factions.CV = { id: 'CV', name: FACTIONS.CV.name, money: 1000000, territories: 0, actions: 0 };
            gameState.factions.TCP = { id: 'TCP', name: FACTIONS.TCP.name, money: 900000, territories: 0, actions: 0 };
            gameState.factions.MIL = { id: 'MIL', name: FACTIONS.MIL.name, money: 800000, territories: 0, actions: 0 };
            gameState.playerFactionId = 'CV';
            FACTIONS.PLAYER = FACTIONS.CV; // Define o player

            // Inicializa localidades usando LOCS_WITH_COORDS (contém x,y)
            gameState.locations = LOCS_WITH_COORDS.map(base => ({
                id: base.id,
                name: base.name,
                zone: base.zone,
                baseIncome: base.baseIncome,
                income: base.baseIncome,
                owner: base.owner,
                force: base.initialForce,
                moral: getRandomInt(80, 100), // Moral inicial alta
                risk: 0,
                policePenaltyTurns: 0,
                x: base.x,
                y: base.y
            }));

            // Contagem inicial de territórios e ajuste de dinheiro (se necessário, mas manteremos o dinheiro base)
            gameState.locations.forEach(loc => {
                gameState.factions[loc.owner].territories++;
            });

            addLog('Início da Guerra dos Territórios. CV é sua facção!', 'system');
            renderGame();
            saveGame();
        };

        // Função de salvamento/carregamento (inclui coords nos locais)
        const saveGame = () => {
            try {
                localStorage.setItem('rioTurfwarsGameState', JSON.stringify(gameState));
                addLog('Jogo salvo localmente.', 'system');
            } catch (e) {
                console.error("Erro ao salvar o jogo:", e);
            }
        };

        const loadGame = () => {
            try {
                const savedState = localStorage.getItem('rioTurfwarsGameState');
                if (savedState) {
                    const loadedState = JSON.parse(savedState);
                    // Garante que as estruturas críticas estão presentes e os IDs das facções base estão corretos
                    if (loadedState.factions && loadedState.factions.CV && loadedState.factions.TCP && loadedState.factions.MIL) {
                        gameState = loadedState;
                        FACTIONS.PLAYER = FACTIONS[gameState.playerFactionId];
                        addLog('Jogo carregado com sucesso.', 'system');
                        return true;
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar o jogo:", e);
                localStorage.removeItem('rioTurfwarsGameState'); // Limpa estado corrompido
            }
            return false;
        };

        // Interações de Modal e Ações
        const handleLocationClick = (locationId) => {
            gameState.selectedLocationId = locationId;
            const loc = gameState.locations.find(l => l.id === locationId);
            const owner = FACTIONS[loc.owner];
            const isPlayerTerritory = loc.owner === gameState.playerFactionId;

            const modal = document.getElementById('interaction-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalDetails = document.getElementById('modal-details');
            const reinforceSection = document.getElementById('reinforce-section');
            const attackSection = document.getElementById('attack-section');

            modalTitle.textContent = loc.name;

            // Renderiza Detalhes
            modalDetails.innerHTML = `
                <p><strong>Dono:</strong> <span class="font-bold" style="color:${owner.colorHex};">${owner.name}</span></p>
                <p><strong>Força Atual:</strong> ${loc.force} / ${MAX_FORCE}</p>
                <p><strong>Moral:</strong> ${loc.moral}%</p>
                <p><strong>Renda Base:</strong> ${formatMoney(loc.baseIncome)}</p>
                <p><strong>Risco Policial:</strong> ${loc.risk.toFixed(1)}%</p>
                <p class="${loc.policePenaltyTurns > 0 ? 'text-red-500 font-semibold' : 'text-green-600'}">Penalidade Policial: ${loc.policePenaltyTurns > 0 ? 'ATIVA' : 'Inativa'}</p>
            `;

            // Configura Seções de Ação
            reinforceSection.classList.toggle('hidden', !isPlayerTerritory);
            attackSection.classList.toggle('hidden', isPlayerTerritory);

            if (isPlayerTerritory) {
                // Ações de Reforço (Apenas para territórios próprios)
                document.getElementById('reinforce-cost').textContent = REINFORCE_COST_PER_POINT.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                
                const reinforceSlider = document.getElementById('reinforce-amount');
                reinforceSlider.max = Math.min(MAX_REINFORCE_PER_TURN, MAX_FORCE - loc.force);
                reinforceSlider.value = Math.min(1, reinforceSlider.max); // Garante que o valor inicial é válido

                // Atualiza o custo e estado inicial do botão de reforço
                updateReinforceCostDisplay();

            } else {
                // Ações de Ataque/Baque (Apenas para territórios rivais)
                const playerTerritories = gameState.locations.filter(l => l.owner === gameState.playerFactionId);
                const select = document.getElementById('attack-origin-select');
                
                // Popula o select com as localidades de origem do jogador
                select.innerHTML = playerTerritories.map(l => `<option value="${l.id}">${l.name} (Força: ${l.force})</option>`).join('');

                // Garante que o display de custo é atualizado ao abrir o modal
                const initialOrigin = select.value;
                const isRaidChecked = document.getElementById('is-raid-checkbox').checked;

                if (initialOrigin) {
                    updateAttackCostDisplay(loc.id, initialOrigin, isRaidChecked);
                } else {
                    document.getElementById('attack-cost-display').innerHTML = '<span class="text-red-500">Você não possui territórios para lançar um ataque!</span>';
                    document.getElementById('btn-attack').disabled = true;
                }
            }

            modal.classList.remove('hidden');
        };

        const updateReinforceCostDisplay = () => {
            const loc = gameState.locations.find(l => l.id === gameState.selectedLocationId);
            const player = gameState.factions[gameState.playerFactionId];
            const reinforceSlider = document.getElementById('reinforce-amount');
            const amount = parseInt(reinforceSlider.value);
            const totalCost = amount * REINFORCE_COST_PER_POINT;
            const btnReinforce = document.getElementById('btn-reinforce');

            document.getElementById('reinforce-value').textContent = `${amount} Ponto(s)`;
            document.getElementById('reinforce-total-cost').textContent = `Custo Total: ${formatMoney(totalCost)}`;

            if (player.money >= totalCost && loc.force < MAX_FORCE) {
                btnReinforce.disabled = false;
                btnReinforce.textContent = `Reforçar (+${amount} Força)`;
            } else if (loc.force >= MAX_FORCE) {
                btnReinforce.disabled = true;
                btnReinforce.textContent = `Força Máxima atingida!`;
            } else {
                btnReinforce.disabled = true;
                btnReinforce.textContent = `Reforçar (Fundo Insuficiente)`;
            }
        };

        const calculateAttackCost = (targetId, originId, isRaid) => {
            const originLoc = gameState.locations.find(l => l.id === originId);
            if (!originLoc) return Infinity; // Previne erro

            const isAdjacent = isLocationAdjacent(targetId, originId);
            let cost = ATTACK_COST_BASE;

            // O custo é influenciado pela força da localidade de origem (tamanho da tropa) e distância
            cost += originLoc.force * 1000;
            if (!isAdjacent) {
                cost *= 1.5; // Custo de logística 50% maior para ataque não adjacente
            }

            if (isRaid) {
                cost *= 0.6; // Baque é 40% mais barato
            }
            return Math.round(cost / 100) * 100; // Arredonda para 100
        };

        const updateAttackCostDisplay = (targetId, originId, isRaid) => {
            const targetLoc = gameState.locations.find(l => l.id === targetId);
            const playerMoney = gameState.factions[gameState.playerFactionId].money;
            const costDisplay = document.getElementById('attack-cost-display');
            const attackButton = document.getElementById('btn-attack');

            if (!originId) {
                costDisplay.innerHTML = '<span class="text-red-500">Selecione um território de origem para calcular o custo.</span>';
                attackButton.disabled = true;
                return;
            }

            const cost = calculateAttackCost(targetId, originId, isRaid);
            const isAdjacent = isLocationAdjacent(targetId, originId);
            
            // Confirma que a penalidade de 50% é aplicada apenas se NÃO for adjacente.
            const penaltyInfo = isAdjacent ? ' (Ataque Adjacente: Sem penalidade)' : ` (Ataque Não Adjacente: -${ADJACENCY_PENALTY * 100}% Força)`;
            const actionType = isRaid ? 'Baque' : 'Invasão';
            const moneyClass = playerMoney >= cost ? 'text-green-600' : 'text-red-600';

            costDisplay.innerHTML = `
                Custo de ${actionType}: <span class="${moneyClass} font-bold">${formatMoney(cost)}</span> + Logística.<br>
                Origem: ${originId}. Alvo: ${targetLoc.name}.${penaltyInfo}
            `;
            attackButton.disabled = playerMoney < cost;
            attackButton.textContent = playerMoney >= cost ? `Realizar ${actionType}` : `${actionType} (Fundo Insuficiente)`;
        };

        const reinforceTerritory = () => {
            const loc = gameState.locations.find(l => l.id === gameState.selectedLocationId);
            const player = gameState.factions[gameState.playerFactionId];
            const reinforceSlider = document.getElementById('reinforce-amount');
            const amount = parseInt(reinforceSlider.value);
            const totalCost = amount * REINFORCE_COST_PER_POINT;

            if (loc.force >= MAX_FORCE || loc.force + amount > MAX_FORCE) {
                addLog(`${loc.name} já tem Força Máxima ou o reforço excede o limite.`, 'info');
                return;
            }
            if (player.money < totalCost) {
                addLog(`Fundo Insuficiente para reforçar ${loc.name}. Necessário: ${formatMoney(totalCost)}.`, 'info');
                return;
            }

            player.money -= totalCost;
            loc.force = Math.min(MAX_FORCE, loc.force + amount);
            addLog(`Você gastou ${formatMoney(totalCost)} para reforçar ${loc.name} (+${amount} Força). Força: ${loc.force}.`, 'success');

            document.getElementById('interaction-modal').classList.add('hidden');
            renderGame();
            saveGame();
        };

        const performAttack = (targetId, originId, isRaid, factionId) => {
            const target = gameState.locations.find(l => l.id === targetId);
            const origin = gameState.locations.find(l => l.id === originId);
            const attackerFaction = gameState.factions[factionId];
            const defenderFaction = gameState.factions[target.owner];
            const isPlayer = factionId === gameState.playerFactionId;

            // 1. Verificação de Validade e Custo
            if (!target || !origin || target.owner === origin.owner || !origin) {
                if (isPlayer) addLog(`Erro: Seleção de origem ou alvo inválida.`, 'system');
                return false;
            }

            const cost = calculateAttackCost(targetId, originId, isRaid);
            if (attackerFaction.money < cost) {
                if (isPlayer) addLog(`Fundo Insuficiente para o ataque em ${target.name}. Necessário: ${formatMoney(cost)}.`, 'info');
                return false;
            }

            // 2. Cálculo de Força e Penalidade
            attackerFaction.money -= cost;
            const isAdjacent = isLocationAdjacent(targetId, originId);
            // Aplica a penalidade de 50% (0.5) se o ataque não for adjacente. Senão, penalty = 1.
            const penalty = isAdjacent ? 1 : ADJACENCY_PENALTY; 

            // Força Efetiva de Combate: Força * Moral (como %) * Penalidade
            const attackerStrength = origin.force * (origin.moral / MAX_MORAL) * penalty;
            const defenderStrength = target.force * (target.moral / MAX_MORAL);

            let message = '';
            let logType = 'attack';
            let attackSuccessful = attackerStrength > defenderStrength;
            
            // Aumento de Risco Policial (Maior para o baque/invasão)
            target.risk += getRandomInt(15, 30);
            origin.risk += getRandomInt(5, 15);


            if (attackSuccessful) {
                // Vitória (Ataque ou Baque)
                if (isRaid) {
                    // Resultado do Baque: Apenas enfraquece a defesa
                    target.moral = Math.max(0, target.moral - getRandomInt(20, 35)); // Aumentado para ser mais eficaz
                    target.force = Math.max(1, target.force - getRandomInt(4, 8));
                    origin.moral = Math.max(0, origin.moral - getRandomInt(5, 10)); 
                    message = `${attackerFaction.name} lançou um BAQUE (Raid) de ${origin.name} contra ${target.name}. Defesas quebradas! Força e Moral do alvo reduzidas.`;
                } else {
                    // Resultado da Invasão: Domínio
                    // Transfere o território
                    defenderFaction.territories--;
                    target.owner = factionId;
                    attackerFaction.territories++;
                    // A nova localidade tem moral baixa
                    target.moral = getRandomInt(30, 50);
                    // Ambas as forças são reduzidas após o combate
                    target.force = Math.max(1, target.force - getRandomInt(5, 10));
                    origin.force = Math.max(1, origin.force - getRandomInt(3, 8));
                    message = `SUCESSO! ${attackerFaction.name} INVASÃO de ${origin.name} dominou ${target.name} de ${defenderFaction.name}! Novo domínio, moral baixa.`;
                    logType = 'success';
                }
            } else {
                // Derrota
                // A força e moral do atacante caem mais
                origin.moral = Math.max(0, origin.moral - getRandomInt(20, 40));
                origin.force = Math.max(1, origin.force - getRandomInt(5, 12));
                // O defensor também sofre perdas
                target.moral = Math.max(0, target.moral - getRandomInt(5, 15));
                target.force = Math.max(1, target.force - getRandomInt(1, 4));
                message = `DERROTA! ${attackerFaction.name} tentou ${isRaid ? 'um Baque' : 'invadir'} ${target.name} de ${origin.name}, mas foi repelido. Perdas significativas para o atacante.`;
                logType = 'info'; // Derrota não é erro, mas info de combate
            }

            addLog(message, logType);

            // Se for o jogador, fecha o modal e renderiza
            if (isPlayer) {
                document.getElementById('interaction-modal').classList.add('hidden');
                renderGame();
                saveGame();
            }
            return true;
        };

        // Lógica de Turno
        const nextTurn = () => {
            document.getElementById('next-turn-button').disabled = true;
            addLog('--- INÍCIO DO TURNO ' + (gameState.turn + 1) + ' ---', 'system');

            // 1. Ações da IA
            aiTurn();

            // 2. Eventos Aleatórios
            handleEvents();

            // 3. Coleta de Renda
            collectIncome();

            // 4. Atualização de Moral e Força
            updateMoraleAndForce();

            // 5. Avança o Turno
            gameState.turn++;
            document.getElementById('next-turn-button').disabled = false;
            renderGame();
            saveGame();
        };

        const collectIncome = () => {
            gameState.locations.forEach(loc => {
                const owner = gameState.factions[loc.owner];
                let income = loc.baseIncome;

                // Penalidade policial
                if (loc.policePenaltyTurns > 0) {
                    income *= 0.5; // 50% de penalidade
                    loc.policePenaltyTurns--;
                }

                owner.money += income;
            });
            addLog('Renda coletada por todas as facções.', 'income');
        };

        const updateMoraleAndForce = () => {
            gameState.locations.forEach(loc => {
                // Aumento natural de Moral (10% a 25% do restante para 100)
                const moralIncrease = Math.round((MAX_MORAL - loc.moral) * getRandomInt(10, 25) / 100);
                loc.moral = Math.min(MAX_MORAL, loc.moral + moralIncrease);
                loc.moral = Math.max(0, loc.moral); // Garante que não é negativo

                // Aumento natural de Força (muito pequeno)
                if (loc.force < MAX_FORCE && Math.random() < 0.1) {
                    loc.force++;
                }
            });
        };

        const handleEvents = () => {
            // Aumenta o multiplicador de risco de operações policiais
            let totalRisk = gameState.locations.reduce((sum, loc) => sum + loc.risk, 0);

            // Eventos globais (ocorrência mais rara)
            if (Math.random() < 0.15) {
                const bonus = getRandomInt(100000, 300000);
                const targetFactionId = ['CV', 'TCP', 'MIL'][getRandomInt(0, 2)];
                gameState.factions[targetFactionId].money += bonus;
                addLog(`BÔNUS ECONÔMICO: ${FACTIONS[targetFactionId].name} recebe um bônus de ${formatMoney(bonus)}!`, 'income');
            }

            // Operações Policiais (Mais provável após combate)
            // Aumentado para ocorrer com mais chance após baque/invasão (risco > 5)
            if (totalRisk > 5 || Math.random() < 0.4) {
                const highRiskLocs = gameState.locations.filter(l => l.risk > 0);
                let targetLoc;

                if (highRiskLocs.length > 0) {
                    // Seleciona um local de alto risco (se houver)
                    targetLoc = highRiskLocs.sort((a, b) => b.risk - a.risk)[0];
                } else {
                    // Ou um local aleatório
                    targetLoc = gameState.locations[getRandomInt(0, gameState.locations.length - 1)];
                }

                // Chance de Operação (agora mais alta devido ao combate)
                if (Math.random() * 15 < targetLoc.risk || Math.random() < 0.7) { 
                    // Diminui moral em 30%-60%
                    const moralDrop = getRandomInt(30, 60);
                    targetLoc.moral = Math.max(0, targetLoc.moral - moralDrop);
                    // Diminui força
                    targetLoc.force = Math.max(1, targetLoc.force - getRandomInt(4, 10)); // Queda de força aumentada
                    // Penalidade de renda
                    targetLoc.policePenaltyTurns = 2; // Penalidade por 2 turnos

                    addLog(`OPERAÇÃO POLICIAL! ${targetLoc.name} foi atingido! Moral caiu ${moralDrop}%, Força reduzida e Renda penalizada por 2 turnos.`, 'police');
                    targetLoc.risk = 0; // Zera o risco após o evento
                }
            }
            // Reduz risco residual
            gameState.locations.forEach(loc => { loc.risk = Math.max(0, loc.risk * 0.5); });
        };

        // Lógica da IA (AI)
        const aiTurn = () => {
            ['TCP', 'MIL'].forEach(aiFactionId => {
                const aiFaction = gameState.factions[aiFactionId];
                const aiLocations = gameState.locations.filter(l => l.owner === aiFactionId);
                const rivalLocations = gameState.locations.filter(l => l.owner !== aiFactionId);

                if (aiLocations.length === 0) return;

                // IA 1: Reforçar (Agora a IA escolhe a quantidade)
                aiLocations.sort((a, b) => (a.force + a.moral) - (b.force + b.moral));
                const reinforceTarget = aiLocations.find(l => l.force < MAX_FORCE);

                if (reinforceTarget && aiFaction.money >= REINFORCE_COST_PER_POINT) {
                    const forceDeficit = MAX_FORCE - reinforceTarget.force;
                    const maxReinforcePoints = Math.min(MAX_REINFORCE_PER_TURN, forceDeficit);
                    
                    // IA decide gastar estrategicamente, até um máximo de 10 pontos
                    let pointsToReinforce = getRandomInt(1, Math.min(10, maxReinforcePoints));
                    
                    // Se a força estiver muito baixa (< 10), a IA tenta gastar mais (até 50% do dinheiro)
                    if (reinforceTarget.force < 10 && aiFaction.money > 100000) {
                        const affordablePoints = Math.floor(aiFaction.money * 0.5 / REINFORCE_COST_PER_POINT);
                        pointsToReinforce = Math.min(maxReinforcePoints, affordablePoints, getRandomInt(5, 10)); // Tenta de 5 a 10
                    } else if (aiLocations.length > 10) {
                         // Se tiver muitos territórios, gasta um pouco menos
                         pointsToReinforce = getRandomInt(1, Math.min(maxReinforcePoints, 5));
                    }


                    const cost = REINFORCE_COST_PER_POINT * pointsToReinforce;
                    if (pointsToReinforce > 0 && aiFaction.money >= cost) {
                        aiFaction.money -= cost;
                        reinforceTarget.force = Math.min(MAX_FORCE, reinforceTarget.force + pointsToReinforce);
                        addLog(`${aiFaction.name} reforçou ${reinforceTarget.name} (+${pointsToReinforce} Força).`, 'info');
                    }
                }

                // IA 2: Ataque ou Baque
                if (Math.random() < 0.6) { // Boa chance de ação ofensiva
                    // Prioriza alvos fracos ou recém-dominados (moral baixa)
                    const potentialTargets = rivalLocations.filter(t => t.force + t.moral < 100 || t.moral < 50); 
                    if (potentialTargets.length === 0) return;

                    // Escolhe o alvo mais fraco no geral
                    let target = potentialTargets.sort((a, b) => (a.force + a.moral) - (b.force + b.moral))[0];
                    let adjacentOrigins = aiLocations.filter(l => isLocationAdjacent(l.id, target.id));
                    
                    // Seleciona a origem mais forte disponível (adjacente ou não)
                    let origin = adjacentOrigins.length > 0 ? 
                                adjacentOrigins.sort((a, b) => b.force - a.force)[0] : // Origem adjacente mais forte
                                aiLocations.sort((a, b) => b.force - a.force)[0]; // Origem mais forte no geral (ataque não adjacente)

                    if (!origin || origin.id === target.id) return;

                    const cost = calculateAttackCost(target.id, origin.id, false); // Calcula o custo da invasão
                    
                    // Decide entre Baque ou Invasão
                    // Faz Baque se a força do atacante for < 1.5x a força do defensor OU o dinheiro for baixo
                    const isRaid = origin.force < target.force * 1.5 || aiFaction.money < cost * 2; 

                    // Verifica se tem dinheiro para a ação escolhida (custo é recalculado dentro do performAttack)
                    const finalCost = calculateAttackCost(target.id, origin.id, isRaid);

                    if (aiFaction.money >= finalCost) {
                       performAttack(target.id, origin.id, isRaid, aiFactionId);
                    }
                }
            });
        };

        // Inicialização e Event Listeners
        const setupEventListeners = () => {
            document.getElementById('next-turn-button').addEventListener('click', nextTurn);
            document.getElementById('btn-close-modal').addEventListener('click', () => {
                document.getElementById('interaction-modal').classList.add('hidden');
            });
            
            // Listeners para a seção de Reforço
            document.getElementById('reinforce-amount').addEventListener('input', updateReinforceCostDisplay);
            document.getElementById('btn-reinforce').addEventListener('click', reinforceTerritory);

            // Listeners para a seção de Ataque
            const attackOriginSelect = document.getElementById('attack-origin-select');
            const isRaidCheckbox = document.getElementById('is-raid-checkbox');
            
            attackOriginSelect.addEventListener('change', () => {
                // Ao mudar a origem, recalcula o custo e a exibição
                updateAttackCostDisplay(gameState.selectedLocationId, attackOriginSelect.value, isRaidCheckbox.checked);
            });
            isRaidCheckbox.addEventListener('change', () => {
                // Ao mudar o tipo de ataque, recalcula o custo e a exibição
                updateAttackCostDisplay(gameState.selectedLocationId, attackOriginSelect.value, isRaidCheckbox.checked);
            });

            document.getElementById('btn-attack').addEventListener('click', () => {
                const targetId = gameState.selectedLocationId;
                const originId = attackOriginSelect.value;
                const isRaid = isRaidCheckbox.checked;

                if (targetId && originId) {
                    performAttack(targetId, originId, isRaid, gameState.playerFactionId);
                }
            });
        };

        const renderGame = () => {
            renderFactionPanel();
            renderMap();
            renderEventLog();
        };

        window.onload = function () {
            setupEventListeners();
            // Tenta carregar, se falhar, inicia um novo jogo
            if (!loadGame()) {
                initGame();
            } else {
                renderGame();
            }

            // DEBUG: log de quantas localidades e exemplos de adjacência
            console.log('Total localidades (coords):', LOCS_WITH_COORDS.length);
            console.log('Exemplo coords (primeiro):', LOCS_WITH_COORDS[0]);
            // imprime pares adjacentes do primeiro para inspecionar
            const firstId = LOCS_WITH_COORDS[0].id;
            console.log('Adjacentes do primeiro (STATIC):', ADJACENCIES_DYNAMIC[firstId] || []);
        };

    </script>
</body>
</html>
